# 跳转节点解析方式和工作原理

## 概述

跳转节点是喵咕记事本树状图的核心功能，它允许用户从树形结构中的节点直接跳转到Markdown文档中对应的代码块。本文档详细介绍跳转节点的解析方式、工作原理以及技术实现。

## 跳转节点语法

### 1. 显式索引跳转

```
节点名称 >java[2]
```

- **语法格式**: `>语言[索引]`
- **功能**: 跳转到文档中第N个指定语言的代码块
- **示例**: `>java[2]` 跳转到第2个java代码块
- **正则表达式**: `/>([a-zA-Z]+)\[(\d+)]/`

### 2. 递增跳转

```
基础语法 >java[1]
进阶用法 >java++
高级特性 >java++
```

- **语法格式**: `>语言++`
- **功能**: 自动递增索引（上一个索引+1）
- **索引变化**: 1 → 2 → 3
- **正则表达式**: `/>([a-zA-Z]+)\+\+/`

### 3. 跳跃增加

```
基础概念 >python[1]
实战项目 >python+=3
```

- **语法格式**: `>语言+=数字`
- **功能**: 从当前索引跳跃增加指定数量
- **索引变化**: 1 → 4（1+3）
- **正则表达式**: `/>([a-zA-Z]+)\+=(\d+)/`

### 4. 同索引复用

```
理论基础 >javascript[1]
相关概念 >javascript
```

- **语法格式**: `>语言`
- **功能**: 复用上一个相同语言的索引值
- **索引保持**: 保持为1
- **正则表达式**: `/>([a-zA-Z]+)(?!\[|\+)/`

## 解析流程

### 1. 文本预处理

```javascript
// 清理回车符和换行符
const cleanLine = trimmedLine.replace(/[\r\n]/g, '');
```

### 2. 语法匹配

解析器按优先级顺序匹配四种跳转语法：

```javascript
// 1. 显式索引匹配
const jumpMatchExplicit = cleanLine.match(/>([a-zA-Z]+)\[(\d+)]/);

// 2. 递增语法匹配
const jumpMatchIncrement = cleanLine.match(/>([a-zA-Z]+)\+\+/);

// 3. 跳跃增加匹配
const jumpMatchJump = cleanLine.match(/>([a-zA-Z]+)\+=(\d+)/);

// 4. 同索引复用匹配
const jumpMatchSame = cleanLine.match(/>([a-zA-Z]+)(?!\[|\+)/);
```

### 3. 索引计算

系统维护一个 `lastJumpIndex` 对象来跟踪每种语言的最后一个跳转索引：

```javascript
const lastJumpIndex = {};

if (jumpMatchExplicit) {
  // 显式指定索引
  jumpIndex = parseInt(jumpMatchExplicit[2]);
  lastJumpIndex[jumpLanguage] = jumpIndex;
} else if (jumpMatchIncrement) {
  // 递增语法
  jumpIndex = (lastJumpIndex[jumpLanguage] || 0) + 1;
  lastJumpIndex[jumpLanguage] = jumpIndex;
} else if (jumpMatchJump) {
  // 跳跃增加
  const jumpAmount = parseInt(jumpMatchJump[2]);
  jumpIndex = (lastJumpIndex[jumpLanguage] || 0) + jumpAmount;
  lastJumpIndex[jumpLanguage] = jumpIndex;
} else if (jumpMatchSame) {
  // 同索引复用
  jumpIndex = lastJumpIndex[jumpLanguage] || 1;
  // 不更新lastJumpIndex，保持原值
}
```

### 4. 标题清理

移除跳转语法，保留干净的节点标题：

```javascript
let cleanTitle = cleanLine
  .replace(/\s*>([a-zA-Z]+)\[(\d+)]\s*$/, '')     // >java[1]
  .replace(/\s*>([a-zA-Z]+)\+=\d+)\s*$/, '')      // >java+=n
  .replace(/\s*>([a-zA-Z]+)\+\+\s*$/, '')        // >java++
  .replace(/\s*>([a-zA-Z]+)(?!\[|\+)\s*$/, '')   // >java
  .trim();
```

## 节点数据结构

解析后的每个节点包含以下属性：

```javascript
const node = {
  key: `node-${keyCounter++}`,        // 唯一标识
  title: cleanTitle,                  // 清理后的标题
  level: level,                       // 缩进级别
  isClickable: isClickable,           // 是否可点击
  jumpLanguage: jumpLanguage,         // 跳转语言
  jumpIndex: jumpIndex,               // 跳转索引
  children: []                        // 子节点
};
```

## 跳转执行机制

### 1. 代码块查找

```javascript
const handleJumpToCode = (jumpLanguage, jumpIndex) => {
  // 查找对应语言和索引的代码块
  const codeBlocks = containerRef.current?.querySelectorAll(
    `pre.language-${jumpLanguage}`
  ) || [];
  
  if (codeBlocks.length >= jumpIndex && jumpIndex > 0) {
    const targetCodeBlock = codeBlocks[jumpIndex - 1]; // 索引从1开始，数组从0开始
    // ...
  }
};
```

### 2. 平滑滚动

```javascript
targetPre.scrollIntoView({
  behavior: 'smooth',
  block: 'center'
});
```

### 3. 视觉反馈

```javascript
// 添加高亮效果
targetPre.style.setProperty('transition', 'all 0.3s ease', 'important');
targetPre.style.setProperty('border', '1px solid rgba(24, 144, 255, 0.5)', 'important');
targetPre.style.setProperty('border-radius', '4px', 'important');

// 3秒后移除高亮效果
setTimeout(() => {
  targetPre.style.removeProperty('border');
  targetPre.style.removeProperty('border-radius');
}, 3000);
```

## 样式系统

### 1. 跳转节点样式

```scss
.tree-node-content.tree-node-clickable {
  cursor: pointer;
  color: #1890ff;
  transition: none !important;
}

// 渐变文字效果
.tree-node-text.has-code {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 600;
}
```

### 2. 主题适配

```scss
// 深色主题下的跳转节点样式
.tree-viewer-card.dark .tree-node-content.tree-node-clickable {
  color: #69c0ff;
  
  &:hover {
    background: transparent !important;
    color: #69c0ff !important;
  }
}
```

## 错误处理

### 1. 代码块不存在

```javascript
if (codeBlocks.length >= jumpIndex && jumpIndex > 0) {
  // 执行跳转
} else {
  message.error(`未找到${jumpLanguage}代码示例#${jumpIndex}`);
}
```

### 2. 语法错误容错

- 无效的跳转语法会被忽略，节点仍然正常显示
- 缺失的索引会使用默认值1
- 非法字符会被过滤

## 性能优化

### 1. 解析优化

- 使用正则表达式预编译
- 单次遍历完成所有语法匹配
- 延迟计算节点层级

### 2. 渲染优化

- 虚拟滚动支持大量节点
- 按需渲染子节点
- CSS样式缓存

### 3. 跳转优化

- DOM查询结果缓存
- 平滑滚动节流
- 高亮效果复用

## 扩展性设计

### 1. 新语法支持

添加新的跳转语法只需：
1. 定义正则表达式
2. 实现索引计算逻辑
3. 添加清理规则

### 2. 自定义跳转行为

```javascript
// 可扩展的跳转处理器
const jumpHandlers = {
  code: handleJumpToCode,
  section: handleJumpToSection,
  image: handleJumpToImage
};
```

## 总结

跳转节点系统通过以下关键技术实现：

1. **灵活的语法设计**: 支持四种不同的跳转语法，满足各种使用场景
2. **智能的索引管理**: 自动跟踪和计算跳转索引，支持递增和跳跃
3. **精确的DOM操作**: 准确定位目标代码块并提供视觉反馈
4. **优雅的用户体验**: 平滑滚动、高亮显示、错误提示
5. **良好的扩展性**: 模块化设计，易于添加新功能

这套系统为用户提供了直观、高效的文档导航体验，是喵咕记事本的核心特色功能之一。